<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="<%= root %>css/post.css">
    <%- include ('fragments/global-head.ejs') %>
    <link rel="stylesheet" href="<%= root %>css/new.css">
    <title>+ new post</title>
</head>
<body>

    <pre style="display: none" id="root"><%= root %></pre>
    <div style="display: none" id="replying_to">
        <% if (locals.replying_to) { %>
            <%= replying_to.path %>
        <% } %>
    </div>

    <%- include('fragments/header.ejs')  %>

    <main>
        <div>
            <label>name</label><br>
            <input autofocus type="text" placeholder="anonymous" id="post-name">

            <br><br>

            <label>post</label><br>
            <div id="post-builder"></div>

            <div class="buttonbar">
                <span>+</span>
                <button onclick="add_post_block('text')">text</button>
                <button onclick="add_post_block('upload')">file(s)</button>
                <button onclick="add_post_block('rec')">rec</button>
                <button onclick="add_post_block('draw')">draw</button>
                <span class="grow"></span>
                <button onclick="upload_post()">post!</button>
            </div>
        </div>

        <% if (locals.replying_to) { %>
            <div class="replying-to">
                <div class="post">
                    <table>
                        <tr>
                            <td>
                                <% if (replying_to.body == '') { %>
                                    replying to
                                    <a href="<%= root %>posts/<%= replying_to.path %>">a shout</a>
                                    by 
                                    <a href="<%= root %>posts/<%= replying_to.path %>"><em><%= replying_to.author %></em></a>...
                                <% } else { %>
                                    replying to
                                    <a href="<%= root %>posts/<%= replying_to.path %>">this post</a>
                                    by 
                                    <a href="<%= root %>posts/<%= replying_to.author_path %>"><em><%= replying_to.author %></em></a>...
                                <% } %>
                            </td>
                        </tr>
                        <% if (replying_to.replying_to) { %>
                            <tr>
                                <td>re:</td>
                                <td>
                                    <a href="<%= root %>posts/<%= replying_to.replying_to.path %>"><%= replying_to.replying_to.title %></a>
                                    <span>by <a href="<%= root %>posts/<%= replying_to.replying_to.author_path %>"><%= replying_to.replying_to.author %></a></span>
                                </td>
                            </tr>
                        <% } %>
                    </table>
                    <% if (replying_to.body != '') { %>
                        <div class="content">
                            <%- replying_to.body %>
                        </div>
                    <% } %>
                </div>
            </div>
        <% } %>
    </main>

    <template id="text-block-template">
        <div class="text block" data-type="text">
            <textarea oninput="this.style.height=''; this.style.height=this.scrollHeight+'px'" placeholder="write here"></textarea>
            <%- include('fragments/post-options.ejs') %>
        </div>
    </template>

    <template id="upload-block-template">
        <div class="upload block" data-type="upload">
            <div class="drop-zone" 
                ondrop="drop(this.parentElement, this, event)" 
                ondragover="dragover(this, event)" 
                ondragleave="this.classList.remove('dragover')"
            >
                <div class="center">
                    drop file(s) here to upload<br>
                    or <button onclick="this.nextElementSibling.click()">browse</button>
                        <input type="file" name="file" multiple="multiple" onchange="add_files(this.parentElement.parentElement.parentElement, this.files)">
                </div>
            </div>
            <%- include('fragments/post-options.ejs') %>
        </div>
    </template>

    <template id="image-block-template">
        <div class="image block" data-type="image">
            <img src="" alt="">
            <%- include('fragments/post-options.ejs') %>
        </div>
    </template>

    <template id="video-block-template">
        <div class="video block" data-type="video">
            <video controls>
                <source src="" type="">
            </video>
            <%- include('fragments/post-options.ejs') %>
        </div>
    </template>

    <template id="album-block-template">
        <div class="album block" data-type="album">
            <div class="slides-wrapper"><div class="slides"></div></div>
            <%- include('fragments/post-options.ejs') %>
        </div>
    </template>

    <template id="audio-block-template">
        <div class="audio block" data-type="audio">
            <audio controls>
                <source src="" type="">
            </audio>
            <%- include('fragments/post-options.ejs') %>
        </div>
    </template>

    <template id="rec-block-template">
        <div class="rec block" data-type="rec">
            <div class="wrapper">
                <img src="<%= root %>res/microphone.png">
                <div class="time">0:00</div>
                <button>stop</button>
            </div>
            <%- include('fragments/post-options.ejs') %>
        </div>
    </template>

    <template id="draw-block-template">
        <div class="draw block" data-type="draw">
            <canvas width="300" height="300"></canvas>
            <div class="buttons">
                <button class="selected"><img src="<%= root %>res/pencil.png"></button>
                <button><img src="<%= root %>res/eraser.png"></button>
            </div>
            <%- include('fragments/post-options.ejs') %>
        </div>
    </template>

    <dialog id="upload-dialog">
        uploading post...
        <br><br>
        <button onclick="uploading_post=false; this.parentElement.close()">cancel</button>
    </dialog>
    
</body>

<script src="<%= root %>js/post.js"></script>
<script src="<%= root %>js/postbuilder.js"></script>
<script>
    treat_posts();
</script>

</html>